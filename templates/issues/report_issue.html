{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}Report Issue - LocalLens{% endblock %}

{% block extra_css %}
<style>
    #map {
        height: 400px;
        border-radius: 8px;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-sm border-0">
                <div class="card-body p-4">
                    <h2 class="card-title mb-4">
                        <i class="fas fa-exclamation-triangle text-warning me-2"></i>Report a Civic Issue
                    </h2>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Click on the map to select the issue location
                    </div>
                    
                    <!-- Map -->
                    <div id="map"></div>
                    
                    <!-- Form -->
                    <form method="post" enctype="multipart/form-data" id="issueForm">
                        {% csrf_token %}
                        {{ form|crispy }}
                        
                        <!-- Submit Button -->
                        <div class="d-grid gap-2 mt-3">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-paper-plane me-2"></i>Submit Report
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        let map, marker;
        let latInput = document.getElementById('id_latitude');
        let lngInput = document.getElementById('id_longitude');
        
        // Initialize map
        map = L.map('map').setView([20.5937, 78.9629], 5);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);
        
        // Try to get user's location
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                map.setView([lat, lng], 13);
                addMarker(lat, lng);
            });
        }
        
        // Add marker on map click
        map.on('click', function(e) {
            addMarker(e.latlng.lat, e.latlng.lng);
            reverseGeocode(e.latlng.lat, e.latlng.lng);
        });
        
        function addMarker(lat, lng) {
            if (marker) {
                map.removeLayer(marker);
            }
            marker = L.marker([lat, lng]).addTo(map);
            if (latInput) latInput.value = lat;
            if (lngInput) lngInput.value = lng;
        }
        
        function reverseGeocode(lat, lng) {
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
                .then(response => response.json())
                .then(data => {
                    if (data.display_name) {
                        const addressInput = document.getElementById('id_address');
                        if (addressInput) {
                            addressInput.value = data.display_name;
                        }
                    }
                })
                .catch(error => console.error('Geocoding error:', error));
        }
        
        // Form submission handler
        const form = document.getElementById('issueForm');
        form.addEventListener('submit', function(e) {
            // Check if location is selected
            if (!latInput || !lngInput || !latInput.value || !lngInput.value) {
                e.preventDefault();
                alert('Please select a location on the map before submitting.');
                return false;
            }
            
            // Show loading state
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Submitting...';
        });
    });
</script>
{% endblock %}